.dindMageJob: &dindMageJob
        image: docker:stable
        services:
                - name: docker:dind
                  command:
                          - "--experimental"
        variables:
                DOCKER_HOST: tcp://docker:2375/
                DOCKER_BUILDKIT: 1
                DOCKER_CLI_EXPERIMENTAL: enabled
        before_script:
                - apk add curl go git musl-dev
                - curl -L https://github.com/docker/buildx/releases/download/v0.3.1/buildx-v0.3.1.linux-amd64 -o docker-buildx
                - chmod +x docker-buildx
                - mkdir -p ~/.docker/cli-plugins/
                - cp docker-buildx ~/.docker/cli-plugins/
                - docker buildx create --name nubuilder
                - docker buildx use nubuilder
                - docker buildx inspect --bootstrap
                - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
                - curl -L https://github.com/magefile/mage/releases/download/v1.9.0/mage_1.9.0_Linux-64bit.tar.gz | tar -zvxf - mage
                - chmod +x mage
                - mv mage /usr/local/bin
                - curl -L https://github.com/tcnksm/ghr/releases/download/v0.13.0/ghr_v0.13.0_linux_amd64.tar.gz | tar -zvxf - ghr_v0.13.0_linux_amd64/ghr
                - chmod +x ghr_v0.13.0_linux_amd64/ghr
                - mv ghr_v0.13.0_linux_amd64/ghr /usr/local/bin
                - docker login ${DOCKER_REGISTRY} --username ${DOCKER_USERNAME} --password ${DOCKER_PASSWORD}

stages:
        - test
        - dockerBuildPushAll
        - dockerManifestBinaryBuildPushAll

testUnitInDockerAll:
        <<: *dindMageJob
        stage: test
        script:
                - mage testUnitInDockerAll

testIntegrationGoInDockerAll:
        <<: *dindMageJob
        stage: test
        script:
                - mage testIntegrationGoInDockerAll

testIntegrationBinaryInDockerAll:
        <<: *dindMageJob
        stage: test
        script:
                - mage testIntegrationBinaryInDockerAll

testIntegrationDockerInDockerAll:
        <<: *dindMageJob
        stage: test
        script:
                - mage testIntegrationDockerInDockerAll

buildPushDockerAll:
        <<: *dindMageJob
        stage: dockerBuildPushAll
        script:
                - mage buildDockerAll pushDockerImageAll

getPushBinaryFromDockerImageAll:
        <<: *dindMageJob
        stage: dockerManifestBinaryBuildPushAll
        script:
                - mage getBinaryFromDockerImageAll
                - ghr -replace -t ${GITHUB_RELEASES_TOKEN} ${GITHUB_RELEASES_VERSION} .bin
        artifacts:
                name: binaries
                paths:
                        - .bin
                expire_in: 120 day

buildPushDockerManifest:
        <<: *dindMageJob
        stage: dockerManifestBinaryBuildPushAll
        script:
                - mage buildDockerManifest pushDockerManifest
